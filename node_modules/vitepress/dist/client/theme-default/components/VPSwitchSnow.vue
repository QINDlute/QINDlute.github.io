<script lang="ts" setup>
import { ref, onMounted } from 'vue'
import VPSwitch from './VPSwitch.vue'
import VPIconSnow from './icons/VPIconSnow.vue'

// 从localStorage读取初始状态，默认关闭
const getInitialState = () => {
  if (typeof window !== 'undefined') {
    const savedState = localStorage.getItem('snowEffectActive')
    return savedState ? JSON.parse(savedState) : false
  }
  return false
}

// 雪花开关状态
const isSnowActive = ref(getInitialState())

// 触发雪花效果的函数
const toggleSnow = () => {
  isSnowActive.value = !isSnowActive.value
  
  // 保存状态到localStorage
  if (typeof window !== 'undefined') {
    localStorage.setItem('snowEffectActive', JSON.stringify(isSnowActive.value))
  }
  
  // 向全局发送自定义事件，用于SnowEffect组件监听
  window.dispatchEvent(new CustomEvent('toggle-snow', {
    detail: { active: isSnowActive.value }
  }))
}

// 组件挂载时，初始化雪花效果状态
onMounted(() => {
  // 发送初始状态事件，确保SnowEffect组件同步状态
  window.dispatchEvent(new CustomEvent('toggle-snow', {
    detail: { active: isSnowActive.value }
  }))
})
</script>

<template>
  <VPSwitch
    title="Toggle snow effect"
    class="VPSwitchSnow"
    :aria-checked="isSnowActive"
    @click="toggleSnow"
  >
    <VPIconSnow class="snowflake-icon" />
  </VPSwitch>
</template>

<style scoped>
.VPSwitchSnow :deep(.check) {
  transition: transform 0.25s ease;
}

/* 开关激活状态下的样式 */
.VPSwitchSnow[aria-checked="true"] :deep(.check) {
  /*rtl:ignore*/
  transform: translateX(18px);
}

/* 雪花图标的样式 */
.VPSwitchSnow :deep(.icon) {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
}

.VPSwitchSnow :deep(.icon) > * {
  width: 24px;
  height: 24px;
  color: var(--vp-c-text-2);
}

.dark .VPSwitchSnow :deep(.icon) > * {
  color: var(--vp-c-text-1);
}
</style>